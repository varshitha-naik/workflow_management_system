<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <div th:replace="~{fragments/layout :: head}"></div>
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div th:replace="~{fragments/layout :: sidebar}"></div>

        <!-- Main Content -->
        <div class="main-wrapper">
            <div th:replace="~{fragments/layout :: topbar}"></div>

            <main class="page-content">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h1>My Assignments</h1>
                        <p class="text-muted">Tasks assigned to you specifically</p>
                    </div>
                </div>

                <!-- Table Area -->
                <div class="card p-0 overflow-hidden">
                    <div id="loading" class="p-8 text-center text-muted">Loading assignments...</div>
                    <div id="assignmentsTableContainer"></div>
                </div>
            </main>
        </div>
    </div>

    <!-- Layout Scripts -->
    <div th:replace="~{fragments/layout :: scripts}"></div>

    <script>
        document.addEventListener('DOMContentLoaded', init);

        async function init() {
            const ctx = requireAuth();
            if (!ctx) return;

            loadAssignments();
        }

        async function loadAssignments() {
            const loading = document.getElementById('loading');
            const container = document.getElementById('assignmentsTableContainer');

            loading.classList.remove('hidden');
            container.innerHTML = '';

            try {
                const assignments = await apiCall('/api/requests/assignments');
                loading.classList.add('hidden');

                if (!assignments || assignments.length === 0) {
                    container.innerHTML = '<div class="p-8 text-center text-muted">No assignments found.</div>';
                    return;
                }

                renderTable('assignmentsTableContainer', [
                    { label: 'Request', key: 'requestId', format: (v) => `#${v}` },
                    { label: 'Assigned At', key: 'assignedAt', format: formatDate },
                    { label: 'Due Date', key: 'dueAt', format: formatDueDate },
                    { label: 'Status', key: 'status', format: renderStatusBadge }
                ], assignments, [
                    {
                        label: 'Open Request',
                        class: 'btn-primary btn-sm',
                        handler: (row) => window.location.href = `/requests/${row.requestId}`
                    }
                ]);

            } catch (err) {
                loading.classList.add('hidden');
                container.innerHTML = `<div class="p-4 text-center text-error">${err.message}</div>`;
            }
        }

        function renderStatusBadge(status) {
            let cls = 'badge-secondary';
            if (status === 'ASSIGNED') cls = 'badge-info';
            if (status === 'COMPLETED') cls = 'badge-success';
            if (status === 'OVERDUE') cls = 'badge-error';
            return `<span class="badge ${cls}">${status}</span>`;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            return new Date(dateStr).toLocaleDateString();
        }

        function formatDueDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            const now = new Date();
            const isOverdue = date < now;
            return `<span class="${isOverdue ? 'text-error font-bold' : ''}">${date.toLocaleDateString()}</span>`;
        }
    </script>
</body>

</html>