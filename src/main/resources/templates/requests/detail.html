<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <div th:replace="~{fragments/layout :: head}"></div>
    <style>
        /* Stepper CSS */
        .stepper {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
            position: relative;
        }

        .stepper::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--bg-dark);
            z-index: 0;
        }

        .step-item {
            position: relative;
            z-index: 1;
            text-align: center;
            background: var(--bg-card);
            padding: 0 10px;
        }

        .step-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-dark);
            color: var(--text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 5px;
            font-weight: bold;
            border: 2px solid var(--border-color);
        }

        .step-item.active .step-circle {
            border-color: var(--primary);
            color: var(--primary);
        }

        .step-item.completed .step-circle {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .step-title {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .step-item.active .step-title {
            color: var(--primary);
            font-weight: bold;
        }

        /* Timeline CSS */
        .timeline-item {
            border-left: 2px solid var(--border-color);
            padding-left: 20px;
            padding-bottom: 20px;
            position: relative;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -6px;
            top: 0;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--primary);
        }

        .timeline-item:last-child {
            border-left: none;
        }

        /* New Visual Styles */
        .step-item.active .step-circle {
            background: var(--primary);
            color: white;
            box-shadow: 0 0 15px var(--primary-glow);
            border-color: var(--primary);
            transform: scale(1.1);
            transition: all 0.3s ease;
        }

        .step-item.completed .step-circle {
            background: var(--success);
            border-color: var(--success);
            color: white;
        }

        .step-item.future {
            opacity: 0.5;
        }

        .border-l-4 {
            border-left-width: 4px;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div th:replace="~{fragments/layout :: sidebar}"></div>

        <!-- Main Content -->
        <div class="main-wrapper">
            <div th:replace="~{fragments/layout :: topbar}"></div>

            <main class="page-content">
                <!-- Header -->
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <div class="flex items-center gap-3">
                            <h1 id="reqTitle">Request #...</h1>
                            <span id="reqStatus" class="badge">Loading...</span>
                        </div>
                        <p id="reqMeta" class="text-muted mt-1">Submitted by ... on ...</p>
                    </div>
                </div>

                <!-- Status Banner -->
                <!-- Status Banner -->
                <div id="statusBanner" class="hidden mb-8 rounded-lg p-4 border border-l-4"></div>

                <!-- Stepper -->
                <div class="card p-6 mb-6 overflow-x-auto">
                    <div id="stepperContainer" class="stepper min-w-[500px]"></div>

                    <!-- Progress Bar -->
                    <div class="mt-8 px-2">
                        <div class="flex justify-between text-sm text-muted mb-1">
                            <span id="progressText">Progress</span>
                            <span id="progressPercent">0%</span>
                        </div>
                        <div class="w-full bg-surface-hover rounded-full h-2">
                            <div id="progressBar" class="bg-primary h-2 rounded-full transition-all duration-500"
                                style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-2 gap-6">
                    <!-- Left: Payload & Details -->
                    <div class="space-y-6">
                        <div class="card p-6">
                            <h3 class="font-bold mb-4 border-b border-gray-700 pb-2">Request Data</h3>
                            <div id="payloadContainer" class="space-y-3">
                                <p class="text-muted italic">No data provided.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Actions & History -->
                    <div class="space-y-6">
                        <!-- Action Card (Conditional) -->
                        <div id="actionCard" class="card p-6 border border-primary hidden"
                            style="border: 1px solid var(--primary);">
                            <h3 class="font-bold mb-2 text-primary">Action Required</h3>
                            <p class="text-sm text-muted mb-4">You are required to review this request at the current
                                step.</p>
                            <div class="flex gap-2">
                                <button onclick="openActionModal('APPROVE')"
                                    class="btn btn-primary flex-1">Approve</button>
                                <button onclick="openActionModal('REJECT')"
                                    class="btn btn-outline flex-1 text-error border-error">Reject</button>
                            </div>
                        </div>

                        <!-- Next Action Info Panel -->
                        <div class="card p-4 bg-surface-hover border-l-4 border-primary">
                            <h3 class="text-xs uppercase tracking-wide text-muted font-bold mb-2">Next Action</h3>
                            <div class="flex items-center gap-3">
                                <div class="p-2 rounded-full bg-primary/20 text-primary">
                                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                                <div>
                                    <div class="font-bold text-white text-sm" id="nextActionRole">Loading...</div>
                                    <div class="text-xs text-muted" id="nextActionStep">Waiting for review...</div>
                                </div>
                            </div>
                        </div>

                        <!-- History -->
                        <div class="card p-6">
                            <h3 class="font-bold mb-4">Activity History</h3>
                            <div id="historyContainer" class="pl-2">Loading history...</div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Action Modal -->
    <div id="actionModal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modalTitle" class="text-xl font-bold mb-4">Approve Request</h2>
            <div id="modalError" class="alert alert-error hidden mb-4"></div>

            <form id="actionForm">
                <input type="hidden" id="actionType">
                <textarea id="comments" class="form-control mb-4" rows="3" placeholder="Add comments..."></textarea>
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="closeActionModal()" class="btn btn-outline">Cancel</button>
                    <button type="submit" id="confirmBtn" class="btn btn-primary">Confirm</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Layout Scripts -->
    <div th:replace="~{fragments/layout :: scripts}"></div>

    <script th:inline="javascript">
        // Inject Request ID from Controller Model if available, or extract from URL?
        // Thymeleaf controller passed 'requestId'.
        const requestId = /*[[${requestId}]]*/ null;
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', init);

        let currentRequest = null;
        let requestSteps = [];

        async function init() {
            const ctx = requireAuth();
            if (!ctx) return;
            if (!requestId) {
                alert("No Request ID provided");
                return;
            }

            Promise.all([loadRequest(), loadHistory()]).then(() => {
                checkPermissions();
            });
        }

        async function loadRequest() {
            try {
                currentRequest = await apiCall(`/requests/${requestId}`);

                // Update Header
                document.getElementById('reqTitle').textContent = `Request #${currentRequest.id}: ${currentRequest.workflowName}`;
                const statusBadge = document.getElementById('reqStatus');
                statusBadge.textContent = currentRequest.status;
                if (currentRequest.status === 'IN_PROGRESS') statusBadge.className = 'badge badge-warning';
                else if (currentRequest.status === 'APPROVED' || currentRequest.status === 'COMPLETED') statusBadge.className = 'badge badge-success';
                else statusBadge.className = 'badge badge-error';

                document.getElementById('reqMeta').textContent = `Submitted by ${currentRequest.createdByUsername} on ${new Date(currentRequest.createdAt).toLocaleString()}`;

                // Render Payload
                const payloadDiv = document.getElementById('payloadContainer');

                if (currentRequest.payload && Object.keys(currentRequest.payload).length > 0) {
                    let itemsHtml = '<div class="data-grid">';

                    for (const [key, val] of Object.entries(currentRequest.payload)) {
                        const lowKey = key.toLowerCase();
                        let icon = '<svg class="data-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'; // default info

                        if (lowKey.includes('amount') || lowKey.includes('price') || lowKey.includes('cost')) {
                            // Money/Numeric icon
                            icon = '<svg class="data-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
                        } else if (lowKey.includes('date') || lowKey.includes('time')) {
                            // Calendar icon
                            icon = '<svg class="data-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>';
                        } else if (lowKey.includes('reason') || lowKey.includes('desc')) {
                            // Text icon
                            icon = '<svg class="data-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path></svg>';
                        }

                        // Highlight numeric amounts
                        const isHighlight = lowKey.includes('amount') || lowKey.includes('price');

                        itemsHtml += `
                            <div class="data-item">
                                <span class="data-label">${icon} ${key}</span>
                                <span class="data-value ${isHighlight ? 'highlight' : ''}">${val}</span>
                            </div>
                        `;
                    }
                    itemsHtml += '</div>';
                    payloadDiv.innerHTML = itemsHtml;
                } else {
                    payloadDiv.innerHTML = `
                        <div class="empty-state-card py-4" style="border:none; background:transparent;">
                             <p class="text-sm text-muted">No data provided.</p>
                        </div>
                    `;
                }

                // Load Steps for Stepper
                const steps = await apiCall(`/workflows/${currentRequest.workflowId}/steps`);
                requestSteps = steps;
                renderStepper(steps, currentRequest.currentStepId, currentRequest.status);

            } catch (err) {
                console.error(err);
                document.querySelector('main').innerHTML = `<div class="p-8 text-center text-error">Failed to load request. ${err.message}</div>`;
            }
        }

        async function loadHistory() {
            try {
                const history = await apiCall(`/requests/${requestId}/history`);
                const container = document.getElementById('historyContainer');

                if (!history || history.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state-card py-4" style="border:none; background:transparent;">
                            <div class="p-3 rounded-full bg-surface-hover mb-2">
                                <svg width="24" height="24" fill="none" stroke="var(--text-muted)" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </div>
                            <p class="text-sm text-muted">No activity recorded yet.</p>
                        </div>
                    `;
                    return;
                }

                const itemsHtml = history.map(h => {
                    let markerClass = 'primary';
                    if (h.actionType === 'APPROVE') markerClass = 'success';
                    if (h.actionType === 'REJECT') markerClass = 'error';

                    const icon = h.actionType === 'APPROVE'
                        ? '<svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>'
                        : h.actionType === 'REJECT'
                            ? '<svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>'
                            : '<svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15l9-5-9-5-9 5 9 5z"></path><path d="M12 15l9-5-9-5-9 5 9 5z" opacity="0.5"></path></svg>'; // Generic activity

                    return `
                    <div class="timeline-item-enhanced">
                        <div class="timeline-marker ${markerClass}">
                            ${icon}
                        </div>
                        <div class="flex justify-between mb-1">
                            <span class="font-bold text-sm">${h.actionByUsername}</span>
                            <span class="text-xs text-muted">${new Date(h.actionTime).toLocaleString()}</span>
                        </div>
                        <div class="mb-2">
                            <span class="badge ${getActionBadgeClass(h.actionType)} text-xs p-1">${h.actionType}</span>
                        </div>
                        <p class="text-sm text-gray-300 bg-surface-hover p-2 rounded border border-gray-700">
                             ${h.comments || 'No comments'}
                        </p>
                        <div class="text-xs text-muted mt-2 pl-1 border-l-2 border-gray-700">
                            ${h.fromStepName} &rarr; ${h.toStepName || 'End'}
                        </div>
                    </div>
                `}).join('');

                container.innerHTML = `<div class="timeline-container">${itemsHtml}</div>`;

            } catch (err) {
                console.error("History load error", err);
            }
        }

        function getActionBadgeClass(type) {
            if (type === 'APPROVE') return 'badge-success';
            if (type === 'REJECT') return 'badge-error';
            return 'badge-info';
        }

        function renderStepper(steps, currentStepId, status) {
            const container = document.getElementById('stepperContainer');
            // Sort steps by order
            steps.sort((a, b) => a.stepOrder - b.stepOrder);

            // Determine active index
            let activeIndex = steps.findIndex(s => s.id === currentStepId);
            if (status === 'COMPLETED') activeIndex = steps.length;
            // If REJECTED, active index is usually the one that was rejected, or we can show it as error.

            container.innerHTML = steps.map((s, idx) => {
                let cls = 'step-item';
                let isCompleted = idx < activeIndex;
                let isActive = idx === activeIndex && status !== 'REJECTED';
                let isError = idx === activeIndex && status === 'REJECTED';

                if (isCompleted) cls += ' completed';
                else if (isActive) cls += ' active';
                else if (isError) cls += ' error';

                // Connector logic
                const showConnector = idx < steps.length - 1;
                const connectorClass = (isCompleted && status !== 'REJECTED') ? 'stepper-connector-line active' : 'stepper-connector-line';

                // Future Step Class
                if (!isCompleted && !isActive && !isError) cls += ' future';

                // Checkmark for completed
                const circleContent = isCompleted
                    ? '<svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>'
                    : (idx + 1);

                return `
                    <div class="flex-1 flex items-center">
                        <div class="${cls} relative z-10 transition-all duration-300">
                            <div class="step-circle mx-auto mb-2">${circleContent}</div>
                            <div class="step-title mt-1">${s.stepName}</div>
                            <div class="text-xs text-muted">${s.requiredRole}</div>
                        </div>
                        ${showConnector ? `<div class="${connectorClass}"></div>` : ''}
                    </div>
                `;
            }).join('');

            // Update Progress Bar
            const total = steps.length;
            const currentIdx = activeIndex + 1; // 1-based display
            // If completed, progress is 100%
            let percent = 0;
            if (status === 'COMPLETED') percent = 100;
            else percent = Math.round(((activeIndex) / total) * 100);

            // Adjust for user friendliness (start at a small non-zero if step 1?)
            if (activeIndex === 0 && status !== 'COMPLETED') percent = 10;
            if (percent > 100) percent = 100;

            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('progressPercent').textContent = `${percent}%`;
            document.getElementById('progressText').textContent = status === 'COMPLETED'
                ? 'Workflow Completed'
                : `Progress: ${percent}% complete (Step ${Math.min(activeIndex + 1, total)} of ${total})`;

            // Adjust container display to ensure flex alignment
            // The container needs to be just 'flex' (it is .stepper already)
            // But we need to make sure items don't shrink weirdly.
        }

        function checkPermissions() {
            if (!currentRequest) return;
            const ctx = getAuthContext(); // { role, username }

            // Find current step object
            const step = requestSteps.find(s => s.id === currentRequest.currentStepId);

            // Update Banner & Next Action Panel
            const banner = document.getElementById('statusBanner');
            const nextActionRole = document.getElementById('nextActionRole');
            const nextActionStep = document.getElementById('nextActionStep');

            if (currentRequest.status === 'COMPLETED') {
                banner.className = 'mb-6 rounded-lg p-4 border border-l-4 bg-success/10 border-success text-white flex items-center gap-3';
                banner.innerHTML = `
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <div>
                        <div class="font-bold">Workflow Completed</div>
                        <div class="text-sm opacity-90">All steps have been finished successfully.</div>
                    </div>
                 `;
                banner.classList.remove('hidden');

                nextActionRole.textContent = 'Completed';
                nextActionStep.textContent = 'Workflow finished';
            } else if (currentRequest.status === 'REJECTED') {
                banner.className = 'mb-6 rounded-lg p-4 border border-l-4 bg-error/10 border-error text-white flex items-center gap-3';
                banner.innerHTML = `
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <div>
                        <div class="font-bold">Request Rejected</div>
                        <div class="text-sm opacity-90">This request has been rejected and closed.</div>
                    </div>
                 `;
                banner.classList.remove('hidden');

                nextActionRole.textContent = 'Rejected';
                nextActionStep.textContent = 'Process stopped';
            } else if (step) {
                // IN PROGRESS
                const isMyTurn = step.requiredRole === ctx.role;
                const readableRole = formatRole(step.requiredRole);

                nextActionRole.textContent = readableRole;
                nextActionStep.textContent = `${step.stepName} Pending`;

                if (isMyTurn) {
                    // ACTION REQUIRED
                    banner.className = 'mb-8 rounded-lg p-4 border border-l-4 bg-primary/10 border-primary text-white flex items-center gap-3';
                    banner.innerHTML = `
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        <div>
                            <div class="font-bold">Action Required</div>
                            <div class="text-sm opacity-90">Please review and process this request.</div>
                        </div>
                    `;
                    banner.classList.remove('hidden');
                    document.getElementById('actionCard').classList.remove('hidden');
                } else {
                    // INFO ONLY
                    banner.className = 'mb-8 rounded-lg p-4 border border-l-4 bg-surface-hover border-gray-600 text-muted flex items-center gap-3';
                    banner.innerHTML = `
                        <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <div>
                             <div class="font-bold text-white">Request Submitted Successfully</div>
                            <div class="text-sm">Current Step: <strong class="text-white">${step.stepName}</strong>. Handled by: <strong class="text-white">${readableRole}</strong>.</div>
                            <div class="text-xs opacity-75 mt-1">No action required from you at this time.</div>
                        </div>
                    `;
                    banner.classList.remove('hidden');
                }
            }
        }

        function formatRole(role) {
            if (!role) return '';
            return role.replace(/_/g, ' ').toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
        }

        // Action Modal Logic
        function openActionModal(type) {
            document.getElementById('actionType').value = type;
            document.getElementById('modalTitle').textContent = type + ' Request';
            document.getElementById('actionModal').classList.add('open');
        }

        function closeActionModal() {
            document.getElementById('actionModal').classList.remove('open');
        }

        document.getElementById('actionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const type = document.getElementById('actionType').value;
            const comments = document.getElementById('comments').value;
            const endpoint = type === 'APPROVE' ? 'approve' : 'reject';

            setLoading('confirmBtn', true);
            try {
                await apiCall(`/requests/${requestId}/${endpoint}`, 'POST', { comments });
                window.location.reload();
            } catch (err) {
                document.getElementById('modalError').textContent = err.message;
                document.getElementById('modalError').classList.remove('hidden');
                setLoading('confirmBtn', false);
            }
        });
    </script>
</body>

</html>