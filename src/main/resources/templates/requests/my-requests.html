<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <div th:replace="~{fragments/layout :: head}"></div>
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div th:replace="~{fragments/layout :: sidebar}"></div>

        <!-- Main Content -->
        <div class="main-wrapper">
            <div th:replace="~{fragments/layout :: topbar}"></div>

            <main class="page-content">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h1>My Requests</h1>
                        <p class="text-muted">Requests you have initiated</p>
                    </div>
                    <a href="/requests/new" class="btn btn-primary">
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                        </svg>
                        New Request
                    </a>
                </div>

                <!-- Table Area -->
                <div class="card p-0 overflow-hidden">
                    <div id="loading" class="p-8 text-center text-muted">Loading your requests...</div>
                    <div id="requestsTableContainer"></div>
                </div>
            </main>
        </div>
    </div>

    <!-- Layout Scripts -->
    <div th:replace="~{fragments/layout :: scripts}"></div>

    <script>
        document.addEventListener('DOMContentLoaded', init);

        async function init() {
            const ctx = requireAuth(); // All roles allowed
            if (!ctx) return;

            loadRequests();
        }

        async function loadRequests() {
            const loading = document.getElementById('loading');
            const container = document.getElementById('requestsTableContainer');

            loading.classList.remove('hidden');
            container.innerHTML = '';

            try {
                const response = await apiCall('/requests/my');
                loading.classList.add('hidden');

                // Normalize response: handle paginated object vs flat array
                let requests = [];
                if (Array.isArray(response)) {
                    requests = response;
                } else if (response && Array.isArray(response.content)) {
                    requests = response.content;
                }

                if (requests.length === 0) {
                    container.innerHTML = `
                        <div class="flex flex-col items-center justify-center p-12 text-center">
                            <div class="p-4 rounded-full bg-surface-hover mb-4">
                                <svg width="48" height="48" fill="none" stroke="var(--text-muted)" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                </svg>
                            </div>
                            <h3 class="text-lg font-bold text-white mb-2">No requests found</h3>
                            <p class="text-muted mb-6">You haven't created any requests yet.</p>
                            <a href="/requests/new" class="btn btn-primary">
                                + Start New Request
                            </a>
                        </div>
                    `;
                    return;
                }

                renderTable('requestsTableContainer', [
                    { label: 'ID', key: 'id', format: (v) => `#${v}` },
                    { label: 'Workflow', key: 'workflowName', format: v => `<span class="font-bold text-white">${v}</span>` },
                    { label: 'Current Step', key: 'currentStepName' },
                    { label: 'Status', key: 'status', format: renderStatusBadge },
                    { label: 'Date', key: 'createdAt', format: formatDate }
                ], requests, [
                    // Inline action fix: previously handler was function object, but renderTable likely expects string name or we need to adjust renderTable to support closure.
                    // Wait, renderTable in app.js takes `actions` array.
                    // Let's check app.js renderTable again. It uses `action.handler` as string inside onclick usually! 
                    // "onclick=\"${action.handler}(${row.id})\""
                    // So passing a function `(id) => ...` will FAIL if renderTable expects string.
                    // However, previous code had `handler: (id) => ...`. That might also be broken if renderTable wasn't updated to support functions.
                    // I will check app.js in my memory.
                    // app.js renderTable: `onclick="${action.handler}(${row.id})"` -> implies handler is a string name of a global function.
                    // BUT, if I want to support inline function, I need to attach it differently or use a global shim.
                    // Safer to define a global function `viewRequest` and use it.
                    {
                        label: 'View Details',
                        class: 'btn-outline btn-sm',
                        handler: 'viewRequestDetails'
                    }
                ], 'viewRequestDetails');

            } catch (err) {
                loading.classList.add('hidden');
                container.innerHTML = `<div class="p-4 text-center text-error">${err.message}</div>`;
            }
        }

        // Global handler for renderTable string reference
        function viewRequestDetails(id) {
            window.location.href = `/requests/${id}`;
        }

        function renderStatusBadge(status) {
            let cls = 'badge-secondary';
            if (status === 'IN_PROGRESS') cls = 'badge-warning';
            if (status === 'APPROVED') cls = 'badge-success';
            if (status === 'REJECTED') cls = 'badge-error';
            if (status === 'COMPLETED') cls = 'badge-success';
            return `<span class="badge ${cls}">${status}</span>`;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            return new Date(dateStr).toLocaleDateString(); // Short date for users
        }
    </script>
</body>

</html>