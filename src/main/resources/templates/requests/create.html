<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <div th:replace="~{fragments/layout :: head}"></div>
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div th:replace="~{fragments/layout :: sidebar}"></div>

        <!-- Main Content -->
        <div class="main-wrapper">
            <div th:replace="~{fragments/layout :: topbar}"></div>

            <main class="page-content">
                <h1 class="mb-4">Create New Request</h1>

                <div class="card max-w-2xl mx-auto">
                    <form id="createRequestForm">
                        <div class="form-group mb-6">
                            <label class="form-label" id="selectionLabel">Select Action</label>
                            <select id="actionId" class="form-control" required>
                                <option value="">Loading actions...</option>
                            </select>

                            <!-- Workflow Preview -->
                            <div id="workflowPreview" class="hidden mt-4 p-4 rounded bg-surface border border-border">
                                <div class="flex items-center gap-3 mb-3">
                                    <div class="p-2 rounded-full bg-primary/10 text-primary">
                                        <svg width="20" height="20" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <h4 class="text-sm font-bold m-0" id="previewTitle">Workflow Name</h4>
                                        <div class="text-xs text-muted" id="previewDesc">Description...</div>
                                    </div>
                                </div>
                                <div class="flex gap-4 text-xs text-muted border-t border-border pt-3">
                                    <div>
                                        <span class="font-bold text-white block" id="previewStepsCount">0</span>
                                        Steps
                                    </div>
                                    <div class="flex-1">
                                        <span class="font-bold text-white block">Flow</span>
                                        <span id="previewFlow">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Dynamic Payload Section -->
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-2">
                                <div>
                                    <label class="form-label m-0">Request Data</label>
                                    <p id="requestDataHelper" class="text-xs text-muted mt-1">Choose what you want to
                                        request.</p>
                                </div>
                                <button type="button" id="addFieldBtn" onclick="addField()"
                                    class="btn btn-outline btn-sm" style="display:none">+ Add Field</button>
                            </div>
                            <div id="payloadFields" class="space-y-3 min-h-[100px]">
                                <!-- Empty State -->
                                <div id="emptyPayloadState"
                                    class="flex flex-col items-center justify-center p-8 border border-dashed border-border rounded text-center">
                                    <div class="p-3 rounded-full bg-surface-hover mb-3">
                                        <svg width="24" height="24" fill="none" stroke="var(--text-muted)"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01">
                                            </path>
                                        </svg>
                                    </div>
                                    <p class="text-sm text-muted opacity-75">No data fields added yet.</p>
                                    <p class="text-xs text-muted mt-1 opacity-50">Add fields to provide data like
                                        Amount, Date, or Reason.</p>
                                </div>
                            </div>
                        </div>

                        <div id="formError" class="alert alert-error hidden mb-4"></div>
                        <div id="formSuccess" class="alert alert-success hidden mb-4"></div>

                        <div class="flex justify-end gap-2 mt-6">
                            <button type="button" onclick="cancelRequest()" class="btn btn-outline">Cancel</button>
                            <button type="submit" id="submitBtn" class="btn btn-primary" disabled>Submit
                                Request</button>
                        </div>
                    </form>
                </div>
            </main>
        </div>
    </div>

    <!-- Layout Scripts -->
    <div th:replace="~{fragments/layout :: scripts}"></div>

    <script>
        document.addEventListener('DOMContentLoaded', init);

        async function init() {
            const ctx = requireAuth(['USER', 'ADMIN', 'SUPER_ADMIN']);
            if (!ctx) return;

            loadActions();
            document.getElementById('createRequestForm').addEventListener('submit', handleSubmit);
            document.getElementById('actionId').addEventListener('change', handleActionChange);

            // Hide/Show Add Field based on role
            if (hasRole(['ADMIN', 'SUPER_ADMIN'])) {
                document.getElementById('addFieldBtn').style.display = '';
            }
        }

        let actionsCache = [];

        async function loadActions() {
            const select = document.getElementById('actionId');
            try {
                // Fetch active actions for USER
                const actions = await apiCall('/request-actions/active');
                actionsCache = actions || [];

                select.innerHTML = '<option value="">-- Select an Action --</option>';
                actionsCache.forEach(a => {
                    if (a.active) {
                        const opt = document.createElement('option');
                        opt.value = a.id;
                        opt.textContent = a.name;
                        // Determine workflow ID from action
                        // Assuming action response has 'workflowId'
                        opt.dataset.workflowId = a.workflowId;
                        select.appendChild(opt);
                    }
                });

                if (actionsCache.length === 0) {
                    select.innerHTML = '<option value="">No actions available</option>';
                    select.disabled = true;
                }

            } catch (err) {
                select.innerHTML = '<option value="">Error loading actions</option>';
                console.error(err);
            }
        }

        async function handleActionChange(e) {
            const actionId = e.target.value;
            const preview = document.getElementById('workflowPreview');
            const helper = document.getElementById('requestDataHelper');
            const helperContainer = document.getElementById('emptyPayloadState');

            if (!actionId) {
                preview.classList.add('hidden');
                helper.classList.remove('hidden');
                clearFields();
                validateForm();
                return;
            }

            // Find selected action
            const action = actionsCache.find(a => a.id == actionId);
            if (!action) return;

            const workflowId = action.workflowId; // from cache

            // Show preview logic (reused but adapted)
            // We still need workflow details for the preview, so we fetch workflow details separately?
            // Or just hide detailed workflow preview from USER?
            // "User MUST NOT see workflow name directly" -> So maybe we show Action Name in preview?
            // Or just simplified preview.

            // Let's keep fetching workflow steps for the "Flow" preview but rename title to Action Name? 
            // The constraint says "User MUST NOT see workflow name directly". 

            preview.classList.remove('hidden');
            helper.classList.add('hidden');

            document.getElementById('previewTitle').textContent = action.name; // Show Action Name
            document.getElementById('previewDesc').textContent = 'Action bound to underlying workflow'; // Generic desc
            document.getElementById('previewFlow').textContent = 'Loading steps...';

            suggestFields(action.name); // Suggest based on Action name now

            // Fetch steps using workflowId
            try {
                const steps = await apiCall(`/workflows/${workflowId}/steps`);
                const sorted = (steps || []).sort((a, b) => a.stepOrder - b.stepOrder);

                document.getElementById('previewStepsCount').textContent = sorted.length;

                if (sorted.length === 0) {
                    document.getElementById('previewFlow').textContent = 'No steps defined';
                } else {
                    const flowStr = sorted.map(s => {
                        let label = s.requiredRole;
                        if (s.autoApprove) label += ' (Auto)';
                        return label;
                    }).join(' → ');
                    document.getElementById('previewFlow').textContent = flowStr;
                }
            } catch (err) {
                console.error("Failed to load steps", err);
                // If user is not allowed to see steps? The requirement "View ordered steps" was in previous prompt.
                // Current prompt says "User should only see business-friendly actions".
                // But let's assume if it fails, just generic message.
                document.getElementById('previewFlow').textContent = 'Standard processing flow';
            }

            validateForm();
        }

        function suggestFields(workflowName) {
            clearFields();

            const name = workflowName.toLowerCase();
            if (name.includes('leave') || name.includes('vacation') || name.includes('off')) {
                addField('Reason', '', 'e.g. Personal Leave');
                addField('From Date', '', 'YYYY-MM-DD');
                addField('To Date', '', 'YYYY-MM-DD');
            } else if (name.includes('expense') || name.includes('reimbursement')) {
                addField('Description', '', 'e.g. Flight tickets');
                addField('Amount', '', '0.00');
                addField('Date', '', 'YYYY-MM-DD');
            } else if (name.includes('access') || name.includes('it request')) {
                addField('System Name', '', 'e.g. AWS Production');
                addField('Access Level', '', 'e.g. Read Only');
                addField('Reason', '', 'e.g. Debugging issue #123');
            } else {
                // Default generic suggestion
                addField('Reason', '', 'Why is this request needed?');
            }
        }

        function clearFields() {
            const container = document.getElementById('payloadFields');
            // Remove all field rows but keep empty state div
            const rows = container.querySelectorAll('.field-row');
            rows.forEach(r => r.remove());
            document.getElementById('emptyPayloadState').classList.remove('hidden');
        }

        function addField(key = '', value = '', placeholderValue = 'Value') {
            // Hide empty state
            document.getElementById('emptyPayloadState').classList.add('hidden');

            const container = document.getElementById('payloadFields');
            const div = document.createElement('div');
            div.className = 'field-row bg-surface p-3 rounded border border-border';
            div.innerHTML = `
                <div class="flex gap-2 items-start">
                    <div class="flex-1">
                        <input type="text" placeholder="Key (e.g. Amount)" class="form-control field-key text-sm" value="${key}" required oninput="validateInput(this); validateForm()">
                        <small class="text-xs text-muted hint-text mt-1 block h-4"></small>
                    </div>
                    <div class="flex-1">
                        <input type="text" placeholder="${placeholderValue}" class="form-control field-value text-sm" value="${value}" required oninput="validateForm()">
                    </div>
                    <button type="button" onclick="removeField(this)" class="btn btn-outline btn-sm text-error hover:border-error" title="Remove Field">×</button>
                </div>
            `;
            container.appendChild(div);

            // Focus value if key provided, else focus key
            if (key) {
                div.querySelector('.field-value').focus();
            } else {
                div.querySelector('.field-key').focus();
            }

            validateForm();
        }

        function removeField(btn) {
            btn.closest('.field-row').remove();

            // Check if empty
            const rows = document.querySelectorAll('.field-row');
            if (rows.length === 0) {
                document.getElementById('emptyPayloadState').classList.remove('hidden');
            }
            validateForm();
        }

        function validateInput(input) {
            const hint = input.parentElement.querySelector('.hint-text');
            const val = input.value.toLowerCase();

            if (val.includes('amount') || val.includes('price') || val.includes('cost')) {
                hint.textContent = 'Tip: Use numeric values for calculations';
            } else if (val.includes('date') || val.includes('time')) {
                hint.textContent = 'Tip: Use YYYY-MM-DD format';
            } else if (val.includes('email')) {
                hint.textContent = 'Tip: Ensure valid email format';
            } else {
                hint.textContent = '';
            }
        }

        function validateForm() {
            const actionSelected = !!document.getElementById('actionId').value;
            const fieldRows = document.querySelectorAll('.field-row');
            let hasValidFields = false;

            // Check if there is at least one field with a key entered
            if (fieldRows.length > 0) {
                for (const row of fieldRows) {
                    const key = row.querySelector('.field-key').value.trim();
                    if (key.length > 0) {
                        hasValidFields = true;
                        break;
                    }
                }
            }

            const btn = document.getElementById('submitBtn');
            btn.disabled = !(actionSelected && hasValidFields);
        }

        function cancelRequest() {
            const hasData = document.querySelectorAll('.field-row').length > 0 || document.getElementById('actionId').value;
            if (hasData) {
                if (!confirm('Discard this request? All entered data will be lost.')) return;
            }
            window.location.href = '/my-requests';
        }

        async function handleSubmit(e) {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            setLoading('submitBtn', true);
            document.getElementById('formError').classList.add('hidden');
            const successDiv = document.getElementById('formSuccess');

            try {
                const actionId = document.getElementById('actionId').value;
                if (!actionId) throw new Error("Please select an action");

                const action = actionsCache.find(a => a.id == actionId);
                const workflowId = action ? action.workflowId : null;
                if (!workflowId) throw new Error("Invalid action configuration");

                // Construct Payload
                const payload = {};
                document.querySelectorAll('.field-row').forEach(div => {
                    const key = div.querySelector('.field-key').value.trim();
                    const value = div.querySelector('.field-value').value.trim();
                    if (key) payload[key] = value;
                });

                const body = {
                    workflowId: workflowId,
                    payload: payload
                };

                const response = await apiCall('/requests', 'POST', body);

                // Show success feedback
                successDiv.classList.remove('hidden');
                successDiv.innerHTML = `Request created successfully! ID: <strong>${response.id || 'N/A'}</strong>. Redirecting...`;

                // Disable form
                document.getElementById('createRequestForm').style.pointerEvents = 'none';

                // Delay redirect
                setTimeout(() => {
                    window.location.href = '/my-requests';
                }, 2000);

            } catch (err) {
                const errDiv = document.getElementById('formError');
                errDiv.textContent = err.message;
                errDiv.classList.remove('hidden');
                setLoading('submitBtn', false, 'Submit Request');
            }
        }
    </script>
</body>

</html>