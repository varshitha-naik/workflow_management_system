<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <div th:replace="~{fragments/layout :: head}"></div>
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div th:replace="~{fragments/layout :: sidebar}"></div>

        <!-- Main Content -->
        <div class="main-wrapper">
            <div th:replace="~{fragments/layout :: topbar}"></div>

            <main class="page-content">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h1>All Requests</h1>
                        <p class="text-muted">Monitor all workflow requests in your tenant</p>
                    </div>
                </div>

                <!-- Table Area -->
                <div class="card p-0 overflow-hidden">
                    <div id="loading" class="p-8 text-center text-muted">Loading requests...</div>
                    <div id="requestsTableContainer"></div>
                </div>
            </main>
        </div>
    </div>

    <!-- Layout Scripts -->
    <div th:replace="~{fragments/layout :: scripts}"></div>

    <script>
        document.addEventListener('DOMContentLoaded', init);

        async function init() {
            const ctx = requireAuth(['SUPER_ADMIN', 'GLOBAL_ADMIN', 'ADMIN', 'TENANT_ADMIN']);
            if (!ctx) return;

            loadRequests();
        }

        async function loadRequests() {
            const loading = document.getElementById('loading');
            const container = document.getElementById('requestsTableContainer');

            loading.classList.remove('hidden');
            container.innerHTML = '';

            try {
                const response = await apiCall('/requests');
                loading.classList.add('hidden');

                // Normalize: Handle Paginated 'Page' object vs List
                let requests = [];
                if (Array.isArray(response)) {
                    requests = response;
                } else if (response && Array.isArray(response.content)) {
                    requests = response.content;
                }

                if (requests.length === 0) {
                    container.innerHTML = '<div class="p-8 text-center text-muted">No requests found.</div>';
                    return;
                }

                const ctx = getAuthContext();
                const myRole = ctx ? ctx.role : '';

                renderTable('requestsTableContainer', [
                    { label: 'ID', key: 'id', format: (v) => `#${v}` },
                    { label: 'Workflow', key: 'workflowName', format: v => `<span class="font-bold text-white">${v}</span>` },
                    { label: 'Created By', key: 'createdByUsername' },
                    { label: 'Current Step', key: 'currentStepName' },
                    { label: 'Role', key: 'currentStepRole', format: v => `<span class="badge badge-gray text-xs">${v}</span>` },
                    { label: 'Status', key: 'status', format: renderStatusBadge },
                    { label: 'Date', key: 'createdAt', format: formatDate }
                ], requests, [
                    {
                        label: 'View',
                        class: 'btn-outline btn-sm',
                        handler: 'viewRequest'
                    },
                    {
                        label: 'Approve',
                        class: 'btn-primary btn-sm',
                        handler: (id) => openActionModal(id, 'APPROVE'),
                        condition: (row) => row.currentStepRole === myRole && row.status === 'IN_PROGRESS'
                    },
                    {
                        label: 'Reject',
                        class: 'btn-outline btn-sm', // Or danger class if customized
                        style: 'color: var(--error); border-color: var(--error);',
                        handler: (id) => openActionModal(id, 'REJECT'),
                        condition: (row) => row.currentStepRole === myRole && row.status === 'IN_PROGRESS'
                    }
                ], 'viewRequest');

            } catch (err) {
                loading.classList.add('hidden');
                container.innerHTML = `<div class="p-4 text-center text-error">${err.message}</div>`;
            }
        }

        function renderStatusBadge(status) {
            let cls = 'badge-secondary';
            if (status === 'IN_PROGRESS') cls = 'badge-warning'; // or info
            if (status === 'APPROVED') cls = 'badge-success';
            if (status === 'REJECTED') cls = 'badge-error';
            if (status === 'COMPLETED') cls = 'badge-success'; // dark green?
            return `<span class="badge ${cls}">${status}</span>`;
        }

        function openActionModal(id, type) {
            // Redirect to detail page to perform action
            window.location.href = `/requests/${id}`;
        }

        function viewRequest(id) {
            window.location.href = `/requests/${id}`;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            return new Date(dateStr).toLocaleDateString() + ' ' + new Date(dateStr).toLocaleTimeString();
        }
    </script>
</body>

</html>