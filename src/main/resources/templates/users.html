<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <div th:replace="~{fragments/layout :: head}"></div>
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div th:replace="~{fragments/layout :: sidebar}"></div>

        <!-- Main Content -->
        <div class="main-wrapper">
            <div th:replace="~{fragments/layout :: topbar}"></div>

            <main class="page-content">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h1>Team Members</h1>
                        <p class="text-muted">Manage team members and permissions</p>
                    </div>
                    <button class="btn btn-primary" onclick="openCreateModal()">
                        <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" />
                        </svg>
                        New User
                    </button>
                </div>

                <!-- Role Filter -->
                <div id="filterContainer" class="card p-4 mb-6 flex items-center gap-4">
                    <div class="flex items-center gap-2">
                        <label class="font-bold text-sm text-muted">Role:</label>
                        <select id="roleFilter" class="form-control w-48">
                            <!-- Populated by JS -->
                        </select>
                    </div>

                    <div class="flex items-center gap-2">
                        <label class="font-bold text-sm text-muted">Status:</label>
                        <select id="statusFilter" class="form-control w-48">
                            <option value="">All Statuses</option>
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </div>

                    <div class="ml-auto text-xs text-muted flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-surface-hover border border-error"></span>
                        Inactive users have not completed activation
                    </div>
                </div>

                <!-- Table Area -->
                <div class="card p-0 overflow-hidden">
                    <div id="loading" class="p-8 text-center text-muted">Loading user directory...</div>
                    <div id="usersTableContainer"></div>
                </div>
            </main>

            <!-- Toast Notification -->
            <div id="toast" style="display: none;"
                class="fixed bottom-4 right-4 bg-gray-800 text-white px-4 py-3 rounded shadow-lg flex items-center gap-3 transform translate-y-10 opacity-0 transition-all duration-300 z-50 pointer-events-none">
                <svg width="20" height="20" class="text-green-500" fill="none" stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                <span id="toastMessage">User invited successfully. Awaiting activation.</span>
            </div>
        </div>
    </div>

    <!-- User Modal -->
    <div id="createModal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modalTitle" class="text-xl font-bold mb-4">Create User</h2>
            <div id="modalError" class="alert alert-error hidden mb-4"></div>

            <form id="createUserForm">
                <input type="hidden" id="editUserId">

                <div class="grid grid-2 gap-4 mb-4">
                    <div class="form-group">
                        <label class="form-label">Username</label>
                        <input type="text" id="username" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Role</label>
                        <select id="role" class="form-control" required>
                            <option value="USER">User</option>
                            <option value="ADMIN" id="roleAdminOption">Admin</option>
                        </select>
                        <small class="text-muted block mt-1 text-xs">Admins and Users will receive an email to set their
                            password before they can log in.</small>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" id="email" class="form-control" required>
                </div>

                <div id="activeGroup" class="form-group mb-6 hidden">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="active" checked>
                        <label for="active" class="m-0 cursor-pointer text-sm">Active Account</label>
                    </div>
                </div>

                <div class="flex justify-end gap-2 mt-6">
                    <button type="button" onclick="closeCreateModal()" class="btn btn-outline">Cancel</button>
                    <button type="submit" id="saveBtn" class="btn btn-primary">Save User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Modal -->
    <div id="deleteModal" class="modal-overlay">
        <div class="modal-content max-w-sm">
            <h2 class="text-xl font-bold mb-2">Delete User</h2>
            <p class="text-muted mb-6">Are you sure you want to remove this user? This action cannot be undone.</p>
            <div id="deleteError" class="alert alert-error hidden mb-4"></div>

            <input type="hidden" id="deleteUserId">

            <div class="flex justify-end gap-2">
                <button onclick="closeDeleteModal()" class="btn btn-outline">Cancel</button>
                <button onclick="confirmDelete()" id="deleteBtn" class="btn btn-danger">Delete User</button>
            </div>
        </div>
    </div>

    <!-- Layout Scripts -->
    <div th:replace="~{fragments/layout :: scripts}"></div>

    <script>
        // JS Logic Preserved and Adapted
        window.usersData = [];

        document.addEventListener('DOMContentLoaded', init);

        async function init() {
            const ctx = requireAuth(['SUPER_ADMIN', 'GLOBAL_ADMIN', 'ADMIN', 'TENANT_ADMIN']);
            if (!ctx) return;

            setupRoleFilter(); // New function call
            loadUsers();

            document.getElementById('roleFilter').addEventListener('change', () => loadUsers());
            document.getElementById('statusFilter').addEventListener('change', () => loadUsers());

            document.getElementById('createUserForm').addEventListener('submit', handleSave);
        }

        function setupRoleFilter() {
            const roleSelect = document.getElementById('roleFilter');
            roleSelect.innerHTML = '';

            if (hasRole(['SUPER_ADMIN', 'GLOBAL_ADMIN'])) {
                // Super Admins see everything
                roleSelect.innerHTML = `
                    <option value="">All Roles</option>
                    <option value="TENANT_ADMIN">Tenant Admins</option>
                    <option value="TENANT_MANAGER">Tenant Managers</option>
                    <option value="USER">Users</option>
                `;
            } else {
                // Tenant Admins see their team
                roleSelect.innerHTML = `
                    <option value="">All Roles</option>
                    <option value="TENANT_MANAGER">Tenant Managers</option>
                    <option value="USER">Users</option>
                `;
            }
        }

        async function loadUsers() {
            const role = document.getElementById('roleFilter').value;
            const status = document.getElementById('statusFilter').value;

            const loading = document.getElementById('loading');
            const container = document.getElementById('usersTableContainer');

            loading.classList.remove('hidden');
            container.innerHTML = '';

            try {
                // Construct URL with params
                const params = new URLSearchParams();
                if (role) params.append('role', role);
                if (status) params.append('active', status);

                const url = '/users?' + params.toString();

                const response = await apiCall(url);

                let displayUsers = Array.isArray(response)
                    ? response
                    : Array.isArray(response.content)
                        ? response.content
                        : [];
                const ctx = getAuthContext();

                // Role-based visibility filtering (Client-side safety)
                if (hasRole(['ADMIN', 'TENANT_ADMIN'])) {
                    // Tenant Admins see all users in their tenant (USER, TENANT_MANAGER, other TENANT_ADMINs)
                    // No strict filtering needed if backend returns correct list, but defensive:
                    displayUsers = displayUsers.filter(u => u.tenantId === ctx.tenantId);
                } else if (hasRole(['SUPER_ADMIN', 'GLOBAL_ADMIN'])) {
                    // Super Admins: strict tenant isolation unless they are 'WorkflowSys' (Platform Owner)
                    if (ctx.tenantName !== 'WorkflowSys') {
                        displayUsers = displayUsers.filter(u => u.tenantId === ctx.tenantId);
                    }
                }

                window.usersData = displayUsers;

                loading.classList.add('hidden');

                const actions = [
                    {
                        label: 'Edit',
                        class: 'btn-outline btn-sm',
                        handler: 'editUser',
                        condition: (row) => {
                            if (hasRole('ADMIN')) {
                                if (row.role === 'ADMIN' || row.role === 'SUPER_ADMIN') return false;
                            }
                            return true;
                        }
                    }
                ];

                // Add Delete action for SUPER_ADMIN / GLOBAL_ADMIN / TENANT_ADMIN
                if (hasRole(['SUPER_ADMIN', 'GLOBAL_ADMIN', 'TENANT_ADMIN'])) {
                    actions.push({
                        label: 'Delete',
                        class: 'btn-danger btn-sm',
                        handler: 'openDeleteModal',
                        condition: (row) => {
                            // Can't delete yourself
                            if (row.username === ctx.username) return false;

                            // TENANT_ADMIN cannot delete GLOBAL_ADMIN (though they shouldn't see them anyway due to filtering)
                            // or other TENANT_ADMINs if that's the rule, but usually admin can delete admin.
                            // Requirement says "Only allow delete if Role = GLOBAL_ADMIN OR TENANT_ADMIN".
                            // And "TENANT_MANAGER and USER should NOT see delete option".
                            // Does not explicitly forbid deleting same-level admins, but let's allow it as standard.

                            return true;
                        }
                    });
                }

                renderTable('usersTableContainer', [
                    { label: 'Username', key: 'username', format: v => `<span class="font-bold text-white">${v}</span>` },
                    { label: 'Email', key: 'email' },
                    {
                        label: 'Role', key: 'role', format: (v) => {
                            let color = 'badge-blue'; // USER
                            if (v === 'TENANT_ADMIN' || v === 'ADMIN' || v === 'GLOBAL_ADMIN' || v === 'SUPER_ADMIN') color = 'badge-warning';
                            if (v === 'TENANT_MANAGER') color = 'badge-purple'; // Purple for Managers
                            return `<span class="badge ${color}">${v}</span>`;
                        }
                    },
                    { label: 'Status', key: 'active', format: (v) => v ? '<span class="badge badge-success">Active</span>' : '<span class="badge badge-error">Inactive</span>' },
                    { label: 'Tenant', key: 'tenantId' }
                ], displayUsers, actions);

            } catch (err) {
                loading.classList.add('hidden');
                container.innerHTML = `<div class="p-4 text-center text-error">${err.message}</div>`;
            }
        }

        window.editUser = function (id) {
            const user = window.usersData.find(u => u.id === id);
            if (!user) return;

            document.getElementById('modalTitle').textContent = 'Edit User';
            document.getElementById('editUserId').value = user.id;
            document.getElementById('username').value = user.username;
            document.getElementById('email').value = user.email;

            // Handle Role Select
            const roleSelect = document.getElementById('role');
            setupRoleOptions();
            roleSelect.value = user.role;

            document.getElementById('active').checked = user.active;
            document.getElementById('activeGroup').classList.remove('hidden');
            document.getElementById('createModal').classList.add('open');
        };

        window.openDeleteModal = function (id) {
            const user = window.usersData.find(u => u.id === id);
            if (!user) return;

            document.getElementById('deleteUserId').value = id;
            document.getElementById('deleteError').classList.add('hidden');
            document.getElementById('deleteModal').classList.add('open');
        };

        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('open');
        }

        async function confirmDelete() {
            const id = document.getElementById('deleteUserId').value;
            setLoading('deleteBtn', true, 'Deleting...');

            try {
                await apiCall(`/users/${id}`, 'DELETE');
                closeDeleteModal();
                showToast('User removed successfully.');
                loadUsers();
            } catch (err) {
                const errDiv = document.getElementById('deleteError');
                errDiv.textContent = err.message || 'Failed to delete user';
                errDiv.classList.remove('hidden');
            } finally {
                setLoading('deleteBtn', false, 'Delete User');
            }
        }

        function openCreateModal() {
            document.getElementById('modalTitle').textContent = 'Create New User';
            document.getElementById('createUserForm').reset();
            document.getElementById('editUserId').value = '';
            document.getElementById('activeGroup').classList.add('hidden');

            setupRoleOptions();
            document.getElementById('role').value = 'USER'; // Default

            document.getElementById('modalError').classList.add('hidden');
            document.getElementById('createModal').classList.add('open');
        }

        function setupRoleOptions() {
            const roleSelect = document.getElementById('role');
            const isGlobal = hasRole(['SUPER_ADMIN', 'GLOBAL_ADMIN']);
            const isTenantAdmin = hasRole(['ADMIN', 'TENANT_ADMIN']);

            // Reset options
            roleSelect.innerHTML = '';

            if (isTenantAdmin) {
                // Tenant Admin can create TENANT_MANAGER and USER
                roleSelect.innerHTML += '<option value="USER">User</option>';
                roleSelect.innerHTML += '<option value="TENANT_MANAGER">Tenant Manager</option>';
            }

            if (isGlobal) {
                // Global Admin can create anything (simplified)
                roleSelect.innerHTML += '<option value="USER">User</option>';
                roleSelect.innerHTML += '<option value="TENANT_MANAGER">Tenant Manager</option>';
                roleSelect.innerHTML += '<option value="TENANT_ADMIN">Tenant Admin</option>';
                roleSelect.innerHTML += '<option value="GLOBAL_ADMIN">Global Admin</option>';
            }
        }

        function closeCreateModal() {
            document.getElementById('createModal').classList.remove('open');
        }

        async function handleSave(e) {
            e.preventDefault();
            const id = document.getElementById('editUserId').value;
            const isEdit = !!id;

            // 2. Loading State with Custom Text
            const loadingText = isEdit ? 'Saving...' : 'Inviting user...';
            setLoading('saveBtn', true, loadingText);

            document.getElementById('modalError').classList.add('hidden');

            try {
                const body = {
                    username: document.getElementById('username').value,
                    email: document.getElementById('email').value,
                    role: document.getElementById('role').value
                };

                if (isEdit) {
                    await apiCall(`/users/${id}`, 'PUT', body);

                    // Handle Status Update separately since it was removed from UserRequest
                    const isActive = document.getElementById('active').checked;
                    const currentUser = window.usersData.find(u => u.id == id);
                    if (currentUser && currentUser.active !== isActive) {
                        await apiCall(`/users/${id}/status`, 'PATCH', { active: isActive });
                    }
                } else {
                    await apiCall('/users', 'POST', body);
                }

                closeCreateModal();
                loadUsers();

                // 3. Success Toast Notification
                // Only show "Awaiting activation" if it was a new user creation or if relevant.
                // The requirement specifically asks for "User invited successfully. Awaiting activation." on creation.
                // For edit, we might want a different message or just default.
                // Assuming refined logic for creation vs edit:
                if (!isEdit) {
                    const email = document.getElementById('email').value;
                    showToast(`Invitation sent to ${email}. Awaiting activation.`);
                } else {
                    // Check if we just activated the user
                    const isActive = document.getElementById('active').checked;
                    const currentUser = window.usersData.find(u => u.id == id);
                    if (currentUser && !currentUser.active && isActive) {
                        const email = document.getElementById('email').value;
                        showToast(`User ${email} activated successfully.`);
                    }
                }

            } catch (err) {
                const errDiv = document.getElementById('modalError');
                errDiv.textContent = err.message || 'An error occurred';
                errDiv.classList.remove('hidden');
            } finally {
                setLoading('saveBtn', false, 'Save User');
            }
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            const msgEl = document.getElementById('toastMessage');
            if (toast && msgEl) {
                msgEl.textContent = message;

                // Show element first
                toast.style.display = 'flex';

                // Small delay to allow display:flex to apply before transition
                requestAnimationFrame(() => {
                    toast.classList.remove('translate-y-10', 'opacity-0', 'pointer-events-none');
                });

                setTimeout(() => {
                    toast.classList.add('translate-y-10', 'opacity-0', 'pointer-events-none');
                    // Wait for transition (300ms) then hide
                    setTimeout(() => {
                        toast.style.display = 'none';
                    }, 300);
                }, 3000);
            }
        }
    </script>
</body>

</html>