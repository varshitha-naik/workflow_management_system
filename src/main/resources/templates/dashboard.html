<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Dashboard - Workflow System</title>
    <link rel="stylesheet" href="/css/style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>
    <header class="header">
        <div class="header-content">
            <a href="/dashboard" class="brand">Workflow Sys</a>
            <div class="nav-user">
                <span id="navUserDisplay" class="hidden-mobile">Loading...</span>
                <a href="/profile" class="profile-link">Profile</a>
                <button onclick="logout()" class="logout-btn">Logout</button>
            </div>
        </div>
    </header>

    <div class="container-dash">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 id="welcomeTitle">Dashboard</h1>
                <p class="subtitle" id="welcomeSubtitle" style="margin-bottom:0">Overview of your system</p>
            </div>
            <div id="tenantTag" class="badge badge-success hidden"></div>
        </div>

        <!-- Stats Grid -->
        <div id="statsGrid" class="dashboard-grid mb-6">
            <!-- Injected by JS -->
        </div>

        <!-- Action Modules -->
        <h2 class="mt-8">Quick Actions</h2>
        <div id="modulesGrid" class="dashboard-grid">
            <a href="/profile" class="card"
                style="padding: 1.5rem; text-decoration: none; color: inherit; display: block;">
                <h3 style="margin-bottom: 0.5rem; font-size: 1.1rem; color: var(--primary);">My Profile</h3>
                <p class="text-muted" style="font-size: 0.9rem;">View and manage your account details.</p>
            </a>
            <!-- Logic will append other modules -->
        </div>
    </div>

    <script src="/js/app.js"></script>
    <script>
        const ctx = requireAuth();

        function logout() {
            clearAuth();
        }

        async function initDashboard() {
            if (!ctx) return;

            // Set Headers
            document.getElementById('welcomeTitle').textContent = `Hello, ${ctx.username}`;
            if (ctx.tenantName) {
                const tag = document.getElementById('tenantTag');
                tag.textContent = ctx.tenantName;
                tag.classList.remove('hidden');
            }

            const statsGrid = document.getElementById('statsGrid');
            const modulesGrid = document.getElementById('modulesGrid');

            // --- SUPER_ADMIN Logic ---
            if (hasRole('SUPER_ADMIN')) {
                // 1. Module: Manage Tenants
                modulesGrid.innerHTML += `
                    <a href="/tenants" class="card" style="padding: 1.5rem; text-decoration: none; color: inherit; display: block;">
                        <h3 style="margin-bottom: 0.5rem; font-size: 1.1rem; color: var(--primary);">Manage Tenants</h3>
                        <p class="text-muted" style="font-size: 0.9rem;">Create, update, and remove system tenants.</p>
                    </a>
                `;

                // 2. Module: Manage Global Users
                modulesGrid.innerHTML += `
                    <a href="/users" class="card" style="padding: 1.5rem; text-decoration: none; color: inherit; display: block;">
                        <h3 style="margin-bottom: 0.5rem; font-size: 1.1rem; color: var(--primary);">Manage Users</h3>
                        <p class="text-muted" style="font-size: 0.9rem;">Administer users across all tenants.</p>
                    </a>
                `;

                // 3. Stats: Fetch Counts
                try {
                    const [tenants, users] = await Promise.all([
                        apiCall('/tenants'),
                        apiCall('/users')
                    ]);

                    if (tenants) {
                        statsGrid.innerHTML += `
                            <div class="stat-card">
                                <div class="stat-value">${tenants.length}</div>
                                <div class="stat-label">Active Tenants</div>
                            </div>
                        `;
                    }
                    if (users) {
                        statsGrid.innerHTML += `
                            <div class="stat-card">
                                <div class="stat-value">${users.length}</div>
                                <div class="stat-label">Total Users</div>
                            </div>
                        `;
                    }
                } catch (e) {
                    console.error("Failed to load stats", e);
                }
            }

            // --- ADMIN Logic ---
            else if (hasRole('ADMIN')) {
                // 1. Module: Manage Users
                modulesGrid.innerHTML += `
                    <a href="/users" class="card" style="padding: 1.5rem; text-decoration: none; color: inherit; display: block;">
                        <h3 style="margin-bottom: 0.5rem; font-size: 1.1rem; color: var(--primary);">Team Members</h3>
                        <p class="text-muted" style="font-size: 0.9rem;">Manage users within your organization.</p>
                    </a>
                `;

                // 2. Module: Tenant Info (View Only)
                // We link to a read-only view or just show it here? 
                // Let's link to tenants page but maybe we need a dedicated "My Tenant" page since /tenants is a list.
                // Or maybe /profile deals with it? 
                // Strict API: GET /api/tenants/{id} is allowed.
                // We can just show a Stat card for "My Tenant" if we want, or add a link.
                // For now, let's just show Users stat.

                try {
                    const users = await apiCall('/users');
                    if (users) {
                        statsGrid.innerHTML += `
                            <div class="stat-card">
                                <div class="stat-value">${users.length}</div>
                                <div class="stat-label">Team Members</div>
                            </div>
                        `;
                    }
                } catch (e) { console.error(e); }
            }

            // --- USER Logic ---
            else {
                // Just Profile, already added default.
                // Maybe a stat for "My Account Status"
                statsGrid.innerHTML += `
                    <div class="stat-card">
                        <div class="stat-value">Active</div>
                        <div class="stat-label">Account Status</div>
                    </div>
                `;
            }
        }

        initDashboard();
    </script>
</body>

</html>