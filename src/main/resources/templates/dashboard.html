<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <div th:replace="~{fragments/layout :: head}"></div>
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div th:replace="~{fragments/layout :: sidebar}"></div>

        <!-- Main Content -->
        <div class="main-wrapper">
            <div th:replace="~{fragments/layout :: topbar}"></div>

            <main class="page-content">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h1 id="welcomeTitle">Dashboard</h1>
                        <p class="text-muted">System Overview & Analytics</p>
                    </div>
                    <div id="tenantTag" class="badge badge-blue hidden"></div>
                </div>

                <!-- Stats Grid -->
                <div id="statsGrid" class="grid grid-4 mb-6">
                    <!-- Default local stat -->
                    <div class="card p-4 skeleton h-24"></div>
                    <div class="card p-4 skeleton h-24"></div>
                    <div class="card p-4 skeleton h-24"></div>
                    <div class="card p-4 skeleton h-24"></div>
                </div>

                <!-- Action Modules -->
                <h2 class="mb-4">Quick Actions</h2>
                <div id="modulesGrid" class="grid grid-3">
                    <a href="/profile" class="card hover:border-primary cursor-pointer block">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="p-2 rounded bg-opacity-10 bg-indigo-500 text-indigo-400">
                                <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                                    <path
                                        d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                                </svg>
                            </span>
                            <h3 class="m-0 text-white">My Profile</h3>
                        </div>
                        <p class="text-muted text-sm">View details</p>
                    </a>
                </div>
            </main>
        </div>
    </div>

    <!-- Layout Scripts -->
    <div th:replace="~{fragments/layout :: scripts}"></div>

    <!-- Dashboard Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const ctx = requireAuth();
            if (!ctx) return;

            document.getElementById('welcomeTitle').textContent = `Hello, ${ctx.username}`;
            if (ctx.tenantName) {
                const tag = document.getElementById('tenantTag');
                tag.textContent = ctx.tenantName;
                tag.classList.remove('hidden');
            }

            const statsGrid = document.getElementById('statsGrid');
            const modulesGrid = document.getElementById('modulesGrid');

            // --- Stats Logic ---
            try {
                // Helper to normalize Page/List responses
                const toArray = (resp) => {
                    if (Array.isArray(resp)) return resp;
                    if (resp && Array.isArray(resp.content)) return resp.content;
                    return [];
                };

                const canViewUsers = hasRole('SUPER_ADMIN') || hasRole('ADMIN');

                const [workflowsResp, requestsResp, usersResp] = await Promise.all([
                    apiCall('/workflows').catch(() => []),
                    apiCall('/requests').catch(() => []),
                    canViewUsers ? apiCall('/users').catch(() => []) : Promise.resolve([])
                ]);

                const workflows = toArray(workflowsResp);
                const requests = toArray(requestsResp);
                const users = toArray(usersResp);

                const activeWorkflows = workflows.filter(w => w.active).length;
                const pendingRequests = requests.filter(r => r.status === 'PENDING').length;

                // Compare YYYY-MM-DD
                const todayStr = new Date().toISOString().split('T')[0];
                const todaysActivity = requests.filter(r => (r.createdAt || '').startsWith(todayStr)).length;

                const totalUsers = canViewUsers ? users.length : '-';

                statsGrid.innerHTML = `
                    <div class="card p-4">
                        <div class="text-muted text-sm">Total Users</div>
                        <div class="text-2xl font-bold text-white mt-2">${totalUsers}</div>
                    </div>
                    <div class="card p-4">
                        <div class="text-muted text-sm">Active Workflows</div>
                        <div class="text-2xl font-bold text-success mt-2">${activeWorkflows}</div>
                    </div>
                    <div class="card p-4">
                        <div class="text-muted text-sm">Pending Requests</div>
                        <div class="text-2xl font-bold text-warning mt-2">${pendingRequests}</div>
                    </div>
                    <div class="card p-4">
                        <div class="text-muted text-sm">Todayâ€™s Activity</div>
                        <div class="text-2xl font-bold text-accent mt-2">${todaysActivity}</div>
                    </div>
                `;

            } catch (e) {
                console.error("Stats load failed", e);
                statsGrid.innerHTML = '<div class="text-error col-span-4">Failed to load system stats.</div>';
            }

            // --- Action Modules Logic ---
            if (hasRole('SUPER_ADMIN')) {
                let superAdminModules = '';
                if (ctx.tenantName === 'WorkflowSys') {
                    superAdminModules += `
                         <a href="/tenants" class="card block hover:border-primary">
                             <h3 class="text-primary mb-1">Manage Tenants</h3>
                             <p class="text-sm">Create and remove system tenants</p>
                         </a>`;
                }
                superAdminModules += `
                     <a href="/users" class="card block hover:border-primary">
                         <h3 class="text-primary mb-1">Users</h3>
                         <p class="text-sm">Administer users for this tenant</p>
                     </a>
                 `;
                modulesGrid.innerHTML += superAdminModules;
            } else if (hasRole('ADMIN')) {
                modulesGrid.innerHTML += `
                     <a href="/users" class="card block hover:border-primary">
                         <h3 class="text-primary mb-1">Team Members</h3>
                         <p class="text-sm">Manage users in ${ctx.tenantName || 'organization'}</p>
                     </a>
                 `;
            }
        });
    </script>
</body>

</html>