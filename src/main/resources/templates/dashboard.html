<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <div th:replace="~{fragments/layout :: head}"></div>
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div th:replace="~{fragments/layout :: sidebar}"></div>

        <!-- Main Content -->
        <div class="main-wrapper">
            <div th:replace="~{fragments/layout :: topbar}"></div>

            <main class="page-content">
                <div class="flex justify-between items-end mb-6">
                    <div>
                        <h1 id="welcomeTitle">Dashboard</h1>
                        <div id="userMeta" class="flex items-center gap-2 mt-2">
                            <!-- Badges will be injected here -->
                        </div>
                    </div>
                    <div class="flex flex-col items-end gap-1">
                        <div class="status-container bg-surface border border-border px-3 py-1 rounded-full">
                            <div class="status-dot"></div>
                            <span class="text-success text-sm font-medium">All systems operational</span>
                        </div>
                        <span class="text-xs text-muted">Last checked just now</span>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div id="statsGrid" class="grid grid-4 mb-6">
                    <!-- Default local stat -->
                    <div class="card p-4 skeleton h-24"></div>
                    <div class="card p-4 skeleton h-24"></div>
                    <div class="card p-4 skeleton h-24"></div>
                    <div class="card p-4 skeleton h-24"></div>
                </div>

                <!-- Action Modules -->
                <h2 class="mb-4">Quick Actions</h2>
                <div id="modulesGrid" class="grid grid-3">
                    <a href="/profile" class="card action-card block cursor-pointer">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="p-2 rounded action-icon-bg">
                                <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                                    <path
                                        d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                                </svg>
                            </span>
                            <h3 class="m-0 text-white">My Profile</h3>
                        </div>
                        <p class="text-muted text-sm">View details</p>
                    </a>
                </div>

                <!-- Recent Activity -->
                <h2 class="mb-4 mt-8">Recent Activity</h2>
                <div class="card p-0 overflow-hidden">
                    <div class="table-container">
                        <table class="w-full">
                            <thead>
                                <tr class="text-left border-b border-border">
                                    <th class="p-4 text-muted font-medium text-sm">User</th>
                                    <th class="p-4 text-muted font-medium text-sm">Action</th>
                                    <th class="p-4 text-muted font-medium text-sm">Entity</th>
                                    <th class="p-4 text-muted font-medium text-sm text-right">Time</th>
                                </tr>
                            </thead>
                            <tbody id="activityTableBody">
                                <tr>
                                    <td colspan="4" class="p-4 text-center text-muted">Loading activity...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Layout Scripts -->
    <div th:replace="~{fragments/layout :: scripts}"></div>

    <!-- Dashboard Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const ctx = requireAuth();
            if (!ctx) return;

            document.getElementById('welcomeTitle').textContent = `Hello, ${ctx.username}`;

            // Time-based greeting
            const hour = new Date().getHours();
            let greeting = 'Good Morning';
            if (hour >= 12 && hour < 17) greeting = 'Good Afternoon';
            else if (hour >= 17) greeting = 'Good Evening';

            document.getElementById('welcomeTitle').textContent = `${greeting}, ${ctx.username}`;

            // Badges
            const userMeta = document.getElementById('userMeta');
            let roleName = 'USER';
            if (hasRole('SUPER_ADMIN')) roleName = 'SUPER ADMIN';
            else if (hasRole('ADMIN')) roleName = 'ADMIN';

            let badgesHtml = `<span class="badge badge-blue text-xs tracking-wider">${roleName}</span>`;

            if (ctx.tenantName) {
                badgesHtml += `<span class="badge badge-success text-xs tracking-wider ml-2">${ctx.tenantName}</span>`;
            }

            userMeta.innerHTML = badgesHtml;

            const statsGrid = document.getElementById('statsGrid');
            const modulesGrid = document.getElementById('modulesGrid');

            // --- Stats Logic ---
            try {
                // Helper to normalize Page/List responses
                const toArray = (resp) => {
                    if (Array.isArray(resp)) return resp;
                    if (resp && Array.isArray(resp.content)) return resp.content;
                    return [];
                };

                const canViewUsers = hasRole('SUPER_ADMIN') || hasRole('ADMIN');

                const [workflowsResp, requestsResp, usersResp] = await Promise.all([
                    apiCall('/workflows').catch(() => []),
                    apiCall('/requests').catch(() => []),
                    canViewUsers ? apiCall('/users').catch(() => []) : Promise.resolve([])
                ]);

                const workflows = toArray(workflowsResp);
                const requests = toArray(requestsResp);
                const users = toArray(usersResp);

                const activeWorkflows = workflows.filter(w => w.active).length;
                const pendingRequests = requests.filter(r => r.status === 'PENDING').length;

                // Compare YYYY-MM-DD
                const todayStr = new Date().toISOString().split('T')[0];
                const todaysActivity = requests.filter(r => (r.createdAt || '').startsWith(todayStr)).length;

                const totalUsers = canViewUsers ? users.length : '-';

                statsGrid.innerHTML = `
                    <div class="card p-4">
                        <div class="text-muted text-sm">Total Users</div>
                        <div class="text-2xl font-bold text-white mt-2">${totalUsers}</div>
                    </div>
                    <div class="card p-4">
                        <div class="text-muted text-sm">Active Workflows</div>
                        <div class="text-2xl font-bold text-success mt-2">${activeWorkflows}</div>
                    </div>
                    <div class="card p-4">
                        <div class="text-muted text-sm">Pending Requests</div>
                        <div class="text-2xl font-bold text-warning mt-2">${pendingRequests}</div>
                    </div>
                    <div class="card p-4">
                        <div class="text-muted text-sm">Todayâ€™s Activity</div>
                        <div class="text-2xl font-bold text-accent mt-2">${todaysActivity}</div>
                    </div>
                `;

            } catch (e) {
                console.error("Stats load failed", e);
                statsGrid.innerHTML = '<div class="text-error col-span-4">Failed to load system stats.</div>';
            }

            // --- Action Modules Logic ---
            if (hasRole('SUPER_ADMIN')) {
                let superAdminModules = '';
                if (ctx.tenantName === 'WorkflowSys') {
                    superAdminModules += `
                         <a href="/tenants" class="card action-card block cursor-pointer">
                             <div class="flex items-center gap-2 mb-2">
                                <span class="p-2 rounded action-icon-bg">
                                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M12 7V3H2v18h20V7H12zM6 19H4v-2h2v2zm0-4H4v-2h2v2zm0-4H4V9h2v2zm0-4H4V5h2v2zm4 12H8v-2h2v2zm0-4H8v-2h2v2zm0-4H8V9h2v2zm0-4H8V5h2v2zm10 12h-8v-2h2v-2h-2v-2h2v-2h-2V9h8v10zm-2-8h-2v2h2v-2zm0 4h-2v2h2v-2z"/></svg>
                                </span>
                                <h3 class="m-0 text-white">Manage Tenants</h3>
                             </div>
                             <p class="text-sm text-muted">Create and remove system tenants</p>
                         </a>`;
                }
                superAdminModules += `
                     <a href="/users" class="card action-card block cursor-pointer">
                         <div class="flex items-center gap-2 mb-2">
                            <span class="p-2 rounded action-icon-bg">
                                <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
                            </span>
                            <h3 class="m-0 text-white">Users</h3>
                         </div>
                         <p class="text-sm text-muted">Administer users for this tenant</p>
                     </a>
                 `;
                modulesGrid.innerHTML += superAdminModules;
            } else if (hasRole('ADMIN')) {
                modulesGrid.innerHTML += `
                     <a href="/users" class="card action-card block cursor-pointer">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="p-2 rounded action-icon-bg">
                                <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
                            </span>
                            <h3 class="m-0 text-white">Team Members</h3>
                        </div>
                        <p class="text-sm text-muted">Manage users in ${ctx.tenantName || 'organization'}</p>
                     </a>
                 `;
            }

            // --- Recent Activity Logic ---
            if (hasRole('SUPER_ADMIN') || hasRole('ADMIN')) {
                try {
                    const tbody = document.getElementById('activityTableBody');
                    const logsResp = await apiCall('/audit-logs?page=0&size=5&sort=timestamp,desc');
                    const logs = logsResp.content || [];

                    if (logs.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-muted">No recent activity</td></tr>';
                    } else {
                        const timeAgo = (dateStr) => {
                            const date = new Date(dateStr);
                            const now = new Date();
                            const seconds = Math.floor((now - date) / 1000);

                            let interval = seconds / 31536000;
                            if (interval > 1) return Math.floor(interval) + " years ago";
                            interval = seconds / 2592000;
                            if (interval > 1) return Math.floor(interval) + " months ago";
                            interval = seconds / 86400;
                            if (interval > 1) return Math.floor(interval) + " days ago";
                            interval = seconds / 3600;
                            if (interval > 1) return Math.floor(interval) + " hours ago";
                            interval = seconds / 60;
                            if (interval > 1) return Math.floor(interval) + " mins ago";
                            return Math.floor(seconds) + " seconds ago";
                        };

                        tbody.innerHTML = logs.map(log => `
                            <tr class="border-b border-border last:border-0 hover:bg-surface-hover transition-colors">
                                <td class="p-4 text-sm font-medium text-white">
                                    <div class="flex items-center gap-2">
                                        <div class="w-6 h-6 rounded-full bg-primary/20 bg-opacity-20 flex items-center justify-content-center text-xs text-primary font-bold uppercase">
                                            ${(log.performedBy || 'sys').charAt(0)}
                                        </div>
                                        ${log.performedBy || 'System'}
                                    </div>
                                </td>
                                <td class="p-4 text-sm">
                                    <span class="badge ${log.action === 'CREATE' ? 'badge-blue' : log.action === 'UPDATE' ? 'badge-warning' : 'badge-success'}">
                                        ${log.action}
                                    </span>
                                </td>
                                <td class="p-4 text-sm text-dim">${log.entityType}</td>
                                <td class="p-4 text-sm text-right text-muted">${timeAgo(log.timestamp)}</td>
                            </tr>
                        `).join('');
                    }
                } catch (e) {
                    console.error("Activity load failed", e);
                    document.getElementById('activityTableBody').innerHTML =
                        '<tr><td colspan="4" class="p-4 text-center text-error">Failed to load activity</td></tr>';
                }
            } else {
                // If standard user, maybe hide the section? Requirement implies only ADMINs usually see audit logs.
                // But let's just leave it empty or hide it.
                // The API is restricted, so we shouldn't call it.
                // Currently only Role Filter was implemented for users.
                // Let's hide the section header and container if not admin.
                document.querySelector('h2.mt-8').style.display = 'none';
                document.querySelector('.card.p-0.overflow-hidden').style.display = 'none';
            }
        });
    </script>
</body>

</html>