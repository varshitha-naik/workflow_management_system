<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Dashboard - Workflow System</title>
    <link rel="stylesheet" href="/css/style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>
    <header class="header">
        <div class="header-content">
            <a href="/dashboard" class="brand">Workflow System</a>
            <div class="nav-user">
                <span id="headerUserName">Loading...</span>
                <span id="tenantBadge" class="hidden"
                    style="background:var(--bg-color); padding: 2px 6px; border-radius: 4px; font-size: 0.75rem;"></span>
                <a href="/profile" class="profile-link">Profile</a>
                <button onclick="logout()" class="logout-btn">Logout</button>
            </div>
        </div>
    </header>

    <div class="container-dash">
        <h2>Dashboard</h2>
        <p class="subtitle">Welcome to your dashboard.</p>

        <div class="card">
            <h3 class="label-text">Your Account</h3>
            <div id="userLoading" class="text-center">Loading user data...</div>
            <div id="userData" class="info-grid hidden">
                <div class="info-item">
                    <div class="info-label">Full Name</div>
                    <div class="info-value" id="dispUsername"></div>
                </div>
                <div class="info-item">
                    <div class="info-label">Email</div>
                    <div class="info-value" id="dispEmail"></div>
                </div>
                <div class="info-item">
                    <div class="info-label">Role</div>
                    <div class="info-value" id="dispRole"></div>
                </div>
                <div class="info-item">
                    <div class="info-label">Tenant</div>
                    <div class="info-value" id="dispTenant"></div>
                </div>
            </div>
        </div>

        <div id="adminSection" class="card mt-4 hidden">
            <h3 class="label-text">Administration</h3>
            <div class="mt-2">
                <a href="/users" class="btn" style="width: auto; display: inline-block; margin-right: 1rem;">Manage
                    Users</a>
                <span id="superAdminActions" class="hidden">
                    <a href="/tenants" class="btn"
                        style="width: auto; display: inline-block; background-color: var(--text-main);">Manage
                        Tenants</a>
                </span>
            </div>
            <p class="subtitle mt-2" style="margin-bottom:0; font-size: 0.85rem;">
                As an admin, you can manage users within your scope.
            </p>
        </div>
    </div>

    <script src="/js/app.js"></script>
    <script>
        const claims = requireAuth();

        if (claims.role === 'SUPER_ADMIN' || claims.role === 'ADMIN') {
            document.getElementById('adminSection').classList.remove('hidden');
        }
        if (claims.role === 'SUPER_ADMIN') {
            document.getElementById('superAdminActions').classList.remove('hidden');
        }

        function logout() {
            clearAuth();
            window.location.href = '/login';
        }

        async function loadData() {
            try {
                // Fetch User
                const user = await apiCall('/users/me');

                document.getElementById('headerUserName').textContent = user.username;
                document.getElementById('dispUsername').textContent = user.username;
                document.getElementById('dispEmail').textContent = user.email;
                document.getElementById('dispRole').textContent = user.role;

                // Fetch Tenant if exists
                if (user.tenantId) {
                    try {
                        const tenant = await apiCall(`/tenants/${user.tenantId}`);
                        document.getElementById('dispTenant').textContent = tenant.name;

                        const badge = document.getElementById('tenantBadge');
                        badge.textContent = tenant.name;
                        badge.classList.remove('hidden');
                    } catch (e) {
                        document.getElementById('dispTenant').textContent = `ID: ${user.tenantId}`;
                    }
                } else {
                    document.getElementById('dispTenant').textContent = 'N/A';
                }

                document.getElementById('userLoading').classList.add('hidden');
                document.getElementById('userData').classList.remove('hidden');

            } catch (err) {
                console.error(err);
                // If auth failed, apiCall redirects. If other error:
                document.getElementById('userLoading').textContent = 'Failed to load data.';
            }
        }

        loadData();
    </script>
</body>

</html>